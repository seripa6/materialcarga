function doPost(e) {
  const acao = e.parameter.acao;
  const codigo = e.parameter.codigo;

  const ss = SpreadsheetApp.openById("18L1VXAsFqNK5kyMUDFFH2Nh6WE9r6f9VgxgKwVfMXwY");
  const abaMaterial = ss.getSheetByName("Material");
  const abaRegistros = ss.getSheetByName("Registros");

  // Buscar material
  if (acao === "buscar") {
    const dados = abaMaterial.getRange(2, 1, abaMaterial.getLastRow(), 3).getValues();
    const item = dados.find(r => String(r[0]) == String(codigo));

    return ContentService.createTextOutput(
      JSON.stringify(
        item
          ? { status: "ok", descricao: item[1], setor: item[2] }
          : { status: "erro" }
      )
    ).setMimeType(ContentService.MimeType.JSON);
  }

  // Registrar entrada ou alteração
  if (acao === "registrar" || acao === "registrarAlteracao") {

    const novoSetor = e.parameter.novoSetor || "Sem alteração";

    // GUARDA COMO TEXTO (preserva zeros)
    abaRegistros.appendRow([new Date(), "'" + codigo, novoSetor]);

    if (acao === "registrarAlteracao") {
      const dados = abaMaterial.getRange(2, 1, abaMaterial.getLastRow(), 3).getValues();
      const index = dados.findIndex(r => String(r[0]) == String(codigo));

      if (index >= 0) {
        abaMaterial.getRange(index + 2, 3).setValue(novoSetor);
      }
    }

    return ContentService.createTextOutput(JSON.stringify({ status: "sucesso" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({ status: "erro" }))
    .setMimeType(ContentService.MimeType.JSON);
}
